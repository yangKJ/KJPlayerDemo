# å‰è¨€
- æœ€è¿‘åœ¨å†™æ’­æ”¾å™¨å£³å­ï¼Œé‡Œé¢æ¶‰åŠåˆ°å…¨å±/åŠå±è½¬æ¢ï¼Œè¿™é‡Œåˆ†äº«ä¸€ä¸‹å½“ä¸­é‡è§çš„é—®é¢˜å’Œå¤„ç†æ€è·¯ï¼Œæ„Ÿå…´è¶£çš„è€å“¥å¯ä»¥å»ä¸‹è½½ç©ç©ï¼Œè§‰å¾—å¥½ç”¨æœ‰å¸®åŠ©è¿˜è¯·ç‚¹ä¸ªå°æ˜Ÿæ˜Ÿ!!!

**Demoåœ°å€ï¼š[KJPlayerDemo](https://github.com/yangKJ/KJPlayerDemo)**

---

### æ•ˆæœé¢„è§ˆ,
<img src="https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/3bd261d418ba49fd8e065850f908490c~tplv-k3u1fbpfcp-watermark.image" width="375" align="center" />

## æ€è·¯åˆ†äº«
ç›®å‰æˆ‘æ‰€çŸ¥é“çš„å…³äºå…¨å±å°±æ˜¯ä»¥ä¸‹å‡ ç§å¤„ç†æ–¹æ¡ˆï¼š

- åŸç”Ÿé¡µé¢æ—‹è½¬ï¼Œå¼ºåˆ¶æ—‹è½¬è®¾å¤‡æ—‹è½¬ï¼Œæ’­æ”¾å™¨æ‰€åœ¨æ§åˆ¶å™¨æ—‹è½¬ä¸ºæ¨ªå±çŠ¶æ€

- æ’­æ”¾å™¨æ‰¿è½½çš„Viewæ—‹è½¬ï¼Œä½¿ç”¨UIViewçš„`transform`å±æ€§æ—‹è½¬90åº¦ï¼Œå…¶å®è¿™ä¸ªå¹¶éçœŸæ­£çš„æ¨ªå±ï¼Œç³»ç»Ÿèœå•æ å’Œç³»ç»Ÿæ§ä»¶ç­‰è¿˜æ˜¯ä¿æŒåŸå…ˆçš„ç«–å±çŠ¶æ€

```
baseView.transform = CGAffineTransformMakeRotation(M_PI_2);
```

- æ—‹è½¬View + æ¨ªå±Windowï¼Œè¿™ç§æ–¹å¼å°±è§£å†³ç¬¬äºŒç§æ²¡æœ‰æ—‹è½¬ç³»ç»Ÿæ§ä»¶çš„é—®é¢˜

### ç¬¬ä¸‰ç§æ€è·¯æ–¹æ¡ˆ
#### 1ã€å­˜å‚¨`frame`ï¼Œåé¢åˆ‡å›å°å±æ—¶åˆ»ä½¿ç”¨  
```
static CGRect _originalFrame;
+ (CGRect)originalFrame{
    return _originalFrame;
}
+ (void)setOriginalFrame:(CGRect)originalFrame{
    _originalFrame = originalFrame;
}
```
#### 2ã€æ—‹è½¬çŠ¶æ€æ æ–¹å‘
```
id<KJPlayerRotateAppDelegate> delegate = (id<KJPlayerRotateAppDelegate>)[[UIApplication sharedApplication] delegate];
NSAssert([delegate conformsToProtocol:@protocol(KJPlayerRotateAppDelegate)], @"Please see the usage documentation!!!");
[delegate kj_transmitCurrentRotateOrientation:UIInterfaceOrientationMaskLandscape];

KJRotateViewController *vc = [[KJRotateViewController alloc] init];
vc.interfaceOrientationMask = UIInterfaceOrientationMaskLandscape;
UIWindow *videoWindow = [[UIWindow alloc] initWithFrame:[UIScreen mainScreen].bounds];
videoWindow.rootViewController = vc;
```
è¿™é‡Œé…ç½®ViewControlleræ¥æ”¯æŒæ—‹è½¬çš„æ–¹å‘ï¼Œè°ƒç”¨Windowçš„rootViewcontrollerçš„`supportedInterfaceOrientations`å’Œ`shouldAutorotate`æ–¹å‘æ¥ç¡®å®šå½“å‰é¡µé¢æ”¯æŒçš„æ–¹å‘

```
@implementation KJRotateViewController
- (BOOL)shouldAutorotate{
    return YES;
}
- (UIInterfaceOrientationMask)supportedInterfaceOrientations{
    return self.interfaceOrientationMask;
}
@end
```
#### 3ã€æ—‹è½¬View
```
baseView.transform = CGAffineTransformMakeRotation(M_PI_2);
baseView.bounds = [UIScreen mainScreen].bounds;
baseView.center = baseView.superview.center;
[baseView setValue:@(YES) forKey:@"isFullScreen"];
```
è¿™é‡Œæœ‰ä¸ªç»†èŠ‚å¤„ç†ï¼Œå°±æ˜¯æˆ‘ä»¬åœ¨æ—‹è½¬åŠ¨ç”»å®Œæˆä¹‹åï¼Œéœ€è¦å°†å±å¹•å›ºå®šä¸ºç«–å±æ–¹å‘

```
id<KJPlayerRotateAppDelegate> delegate = (id<KJPlayerRotateAppDelegate>)[[UIApplication sharedApplication] delegate];
[delegate kj_transmitCurrentRotateOrientation:UIInterfaceOrientationMaskPortrait];
```
åˆ°æ­¤å…¨å±æ¨¡å¼æ€è·¯å°±å·®ä¸å¤šéƒ½å‡ºæ¥äº†ï¼Œå…·ä½“éœ€è¦æ³¨æ„çš„åœ°æ–¹å°±æ˜¯éœ€è¦Appdelegateå½“ä¸­å®ç°`KJPlayerRotateAppDelegate`

å‚è€ƒæ–‡æ¡£ï¼Œ[iOSç«¯ä¸€æ¬¡è§†é¢‘å…¨å±éœ€æ±‚çš„å®ç°](https://www.jianshu.com/p/4d707708830b?utm_campaign=hugo&utm_medium=reader_share&utm_content=note)ï¼Œ

### æˆ‘å·²å°†ä¹‹å°è£…æˆå·¥å…·
ç›´æ¥è´´å‡ºå®ç°ä»£ç 

```
#import <Foundation/Foundation.h>
#import <UIKit/UIKit.h>

NS_ASSUME_NONNULL_BEGIN
/* å¿…é¡»åœ¨Appdelegateå½“ä¸­å®ç°è¯¥åè®® */
@protocol KJPlayerRotateAppDelegate <NSObject>
/* ä¼ é€’å½“å‰æ—‹è½¬æ–¹å‘ */
- (void)kj_transmitCurrentRotateOrientation:(UIInterfaceOrientationMask)rotateOrientation;

@end
@class KJBasePlayerView;
@interface KJRotateManager : NSObject
/* åˆ‡æ¢åˆ°å…¨å± */
+ (void)kj_rotateFullScreenBasePlayerView:(UIView*)baseView;
/* åˆ‡æ¢åˆ°å°å± */
+ (void)kj_rotateSmallScreenBasePlayerView:(UIView*)baseView;
/* åˆ‡æ¢åˆ°æµ®çª—å± */
+ (void)kj_rotateFloatingWindowBasePlayerView:(UIView*)baseView;

@end

NS_ASSUME_NONNULL_END
```
```
#import "KJRotateManager.h"
#define kRotate_KeyWindow \
({UIWindow *window;\
if (@available(iOS 13.0, *)) {\
window = [UIApplication sharedApplication].windows.firstObject;\
}else{\
window = [UIApplication sharedApplication].keyWindow;\
}\
window;})
//æ—‹è½¬ä¸­é—´æ§åˆ¶å™¨
@interface KJRotateViewController : UIViewController
@property (nonatomic, assign) UIInterfaceOrientationMask interfaceOrientationMask;
@end

@interface KJRotateManager ()
@property(nonatomic,assign,class)CGRect originalFrame;
@end
@implementation KJRotateManager
/* åˆ‡æ¢åˆ°å…¨å± */
+ (void)kj_rotateFullScreenBasePlayerView:(UIView*)baseView{
    self.originalFrame = baseView.frame;
    id<KJPlayerRotateAppDelegate> delegate = (id<KJPlayerRotateAppDelegate>)[[UIApplication sharedApplication] delegate];
    NSAssert([delegate conformsToProtocol:@protocol(KJPlayerRotateAppDelegate)], @"Please see the usage documentation!!!");
    [delegate kj_transmitCurrentRotateOrientation:UIInterfaceOrientationMaskLandscape];

    KJRotateViewController *vc = [[KJRotateViewController alloc] init];
    vc.interfaceOrientationMask = UIInterfaceOrientationMaskLandscape;
    UIWindow *videoWindow = [[UIWindow alloc] initWithFrame:[UIScreen mainScreen].bounds];
    videoWindow.rootViewController = vc;
    [UIView animateWithDuration:0.3f animations:^{
        baseView.transform = CGAffineTransformMakeRotation(M_PI_2);
        baseView.bounds = [UIScreen mainScreen].bounds;
        baseView.center = baseView.superview.center;
        [baseView setValue:@(YES) forKey:@"isFullScreen"];
    } completion:^(BOOL finished) {
        id<KJPlayerRotateAppDelegate> delegate = (id<KJPlayerRotateAppDelegate>)[[UIApplication sharedApplication] delegate];
        [delegate kj_transmitCurrentRotateOrientation:UIInterfaceOrientationMaskPortrait];
    }];
}
/* åˆ‡æ¢åˆ°å°å± */
+ (void)kj_rotateSmallScreenBasePlayerView:(UIView*)baseView{
    id<KJPlayerRotateAppDelegate> delegate = (id<KJPlayerRotateAppDelegate>)[[UIApplication sharedApplication] delegate];
    NSAssert([delegate conformsToProtocol:@protocol(KJPlayerRotateAppDelegate)], @"Please see the usage documentation!!!");
    [delegate kj_transmitCurrentRotateOrientation:UIInterfaceOrientationMaskPortrait];
    
    KJRotateViewController *vc = [[KJRotateViewController alloc] init];
    vc.interfaceOrientationMask = UIInterfaceOrientationMaskPortrait;
    UIWindow *videoWindow = [[UIWindow alloc] initWithFrame:[UIScreen mainScreen].bounds];
    videoWindow.rootViewController = vc;
    [UIView animateWithDuration:0.3f animations:^{
        baseView.transform = CGAffineTransformIdentity;
        baseView.frame = self.originalFrame;
        [baseView setValue:@(NO) forKey:@"isFullScreen"];
    }];
}
/* åˆ‡æ¢åˆ°æµ®çª—å± */
+ (void)kj_rotateFloatingWindowBasePlayerView:(UIView*)baseView{
    // TODO:
}

#pragma mark - getter/setter
static CGRect _originalFrame;
+ (CGRect)originalFrame{
    return _originalFrame;
}
+ (void)setOriginalFrame:(CGRect)originalFrame{
    _originalFrame = originalFrame;
}
+ (UIViewController*)topViewController{
    UIViewController *result = nil;
    UIWindow * window = kRotate_KeyWindow;
    if (window.windowLevel != UIWindowLevelNormal){
        NSArray *windows = [[UIApplication sharedApplication] windows];
        for(UIWindow * tmpWin in windows){
            if (tmpWin.windowLevel == UIWindowLevelNormal){
                window = tmpWin;
                break;
            }
        }
    }
    UIViewController *vc = window.rootViewController;
    while (vc.presentedViewController) {
        vc = vc.presentedViewController;
    }
    if ([vc isKindOfClass:[UITabBarController class]]){
        UITabBarController * tabbar = (UITabBarController *)vc;
        UINavigationController * nav = (UINavigationController *)tabbar.viewControllers[tabbar.selectedIndex];
        result = nav.childViewControllers.lastObject;
    }else if ([vc isKindOfClass:[UINavigationController class]]){
        UIViewController * nav = (UIViewController *)vc;
        result = nav.childViewControllers.lastObject;
    }else{
        result = vc;
    }
    return result;
}

@end

/* ************************* é»„é‡‘åˆ†å‰²çº¿ ***************************/

@implementation KJRotateViewController
/// ç”µæ± çŠ¶æ€æ ç®¡ç†
- (BOOL)prefersStatusBarHidden{
    return YES;
}
- (BOOL)shouldAutorotate{
    return YES;
}
- (UIInterfaceOrientationMask)supportedInterfaceOrientations{
    return self.interfaceOrientationMask;
}

@end
```
> åˆ°æ­¤ï¼Œå…³äºå…¨å±æ¨¡å¼æ€è·¯ä»‹ç»çš„å·®ä¸å¤šäº†ï¼Œè‡³äºè¯¦ç»†ä¿¡æ¯ï¼Œæˆ‘Dmeoé‡Œé¢å†™çš„ä¹Ÿå¾ˆè¯¦ç»†ï¼Œæ„Ÿå…´è¶£çš„æœ‹å‹å¯ä»¥å»ä¸‹è½½ **Demoåœ°å€ï¼š[KJPlayerDemo](https://github.com/yangKJ/KJPlayerDemo)**

## ä½¿ç”¨æ³¨æ„äº‹é¡¹
### å…³äºå…¨å±/åŠå±é…ç½®ä¿¡æ¯
è¯·åœ¨Appdelegateå½“ä¸­å®ç°è¯¥åè®®`KJPlayerRotateAppDelegate`

```
@interface AppDelegate ()<KJPlayerRotateAppDelegate>
@property(nonatomic,assign) UIInterfaceOrientationMask rotateOrientation;
@end

@implementation AppDelegate
/* ä¼ é€’å½“å‰æ—‹è½¬æ–¹å‘ */
- (void)kj_transmitCurrentRotateOrientation:(UIInterfaceOrientationMask)rotateOrientation{
    self.rotateOrientation = rotateOrientation;
}
- (UIInterfaceOrientationMask)application:(UIApplication *)application supportedInterfaceOrientationsForWindow:(UIWindow *)window{
    if (self.rotateOrientation) {
        return self.rotateOrientation;
    }else{
        return UIInterfaceOrientationMaskPortrait;
    }
}
@end
```

### å…«é˜¿å“¥æ€»ç»“
æœç„¶ä»£ç éƒ½æ˜¯ç»ä¸èµ·æµ‹è¯•è°ƒè¯•çš„ï¼Œä¸€å¦‚æ—¢å¾€çš„åˆå‡ºç°bug

#### 1ã€è§†å›¾å±‚æ¬¡æ˜¾ç¤ºé—®é¢˜
æ§ä»¶`KJBasePlayerView`æ˜¯ä¼˜å…ˆäºåé¢çš„æŒ‰é’®Addåœ¨`self.view`ä¸Šï¼Œæ‰€ä»¥å½“æˆ‘æŒ‰ä¸‹å…¨å±æŒ‰é’®ä¹‹æ—¶å°±å‡ºç°ä¸‹é¢çš„é—®é¢˜ ğŸ˜“ğŸ˜“- -ï¼

<img src="https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/717f8dbbcd5a472595cc29ec8f5aeca1~tplv-k3u1fbpfcp-watermark.image" width="667" align="center" />

è§£å†³æ–¹æ¡ˆï¼šä¿®æ”¹`KJBasePlayerView`çš„`zPosition`å±æ€§ï¼Œæ­£å¸¸è®¾ç½®çš„æ§ä»¶å¯¹åº”çš„`layer.zPosition`é»˜è®¤éƒ½æ˜¯`0`ï¼Œæ‰€ä»¥åªéœ€è¦å°†æ§ä»¶çš„`layer.zPosition`è®¾ç½®ä¸º`1`å°±è§£å†³

```
- (instancetype)initWithFrame:(CGRect)frame{
    if (self = [super initWithFrame:frame]) {
        self.layer.zPosition = 1;
        [self kj_initializeConfiguration];
    }
    return self;
}
```

#### 2ã€é¡¶éƒ¨å¯¼èˆªæ é—®é¢˜
ç°åœ¨è¿˜æœ‰ä¸€ä¸ªé—®é¢˜å°±æ˜¯ä¸Šé¢çš„å¯¼èˆªæ ï¼Œè¿™ä¸ªæˆ‘ç›®å‰èƒ½æƒ³åˆ°çš„ç¬¨åŠæ³•å°±æ˜¯ï¼Œæˆ‘ä¸æ˜¯æœ‰æŠŠå½“å‰å…¨å±/åŠå±çŠ¶æ€é€šè¿‡å›è°ƒè¿”å‡ºæ¥å˜›ï¼Œç„¶ååœ¨å›è°ƒå½“ä¸­å»æ§åˆ¶éšè—/æ˜¾ç¤º

```
PLAYER_WEAKSELF;
self.basePlayerView.kVideoChangeScreenState = ^(KJPlayerVideoScreenState state) {
    if (state == KJPlayerVideoScreenStateFullScreen) {
        [weakself.navigationController setNavigationBarHidden:YES animated:YES];
    }else{
        [weakself.navigationController setNavigationBarHidden:NO animated:YES];
    }
};
```
ä¸çŸ¥å“ªä½å¤§ç¥æˆ–è€…æœ‰æ›´å¥½æ›´æ–¹ä¾¿çš„è§£å†³æ–¹å¼ï¼Œæ¬¢è¿æŒ‡ç‚¹ä¸€ä¸‹ï¼Œè°¢è°¢ï½ğŸ˜

## æ–‡ç« å…³è”
### å…³äºæ’­æ”¾å™¨å…¶ä»–ç›¸å…³æ–‡ç« 
- **[å¼€å‘æ’­æ”¾å™¨æ¡†æ¶ä¹‹å…¨å±å¤„ç†](https://juejin.cn/post/6933484150347284488)**
- **[å¼€å‘æ’­æ”¾å™¨æ¡†æ¶ä¹‹è¾¹ä¸‹è¾¹æ’­è¾¹å­˜æ–¹æ¡ˆåˆ†äº«](https://juejin.cn/post/6933484618398203911)**

### åç»­è¯¥æ’­æ”¾å™¨å£³å­æˆ‘ä¼šæ…¢æ…¢è¡¥å……å®Œå–„ï¼Œè€å“¥è§‰å¾—å¥½ç”¨è¿˜è¯·å¸®æˆ‘ç‚¹ä¸ª**[å°æ˜Ÿæ˜Ÿ](https://github.com/yangKJ/KJPlayerDemo)**ä¼ é€é—¨
